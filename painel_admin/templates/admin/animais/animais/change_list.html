{% extends "partials/sidebar.html" %}
{% load admin_list static %}
{% load admin_urls %}


{% block extrastyle %}
<link rel="stylesheet" href="{% static "global/css/change_list.css" %}">
{% endblock extrastyle %}
{% block content-pad %}
<h1>Gerenciar Animais</h1>

<div class="search-content">
  <form method="get" class="search-container">
    <div class="search-input-wrapper">
      <input type="text" name="q" placeholder="Buscar..." value="{{ cl.query }}">
      <i class="fas fa-filter" id="open-filters"></i>
    </div>
    <div class="search-buttons">
      <button type="submit"><i class="fas fa-search"></i> Buscar</button>
      {% if has_add_permission %}
        <a href="{% url opts|admin_urlname:'add' %}" class="btn-add">
          <i class="fas fa-plus" title='Adicionar'></i> Adicionar
        </a>
      {% endif %}
    </div>
  </form>
</div>

<aside id="filters-sidebar" class="filters-sidebar">
  <header>
    <h2>Filtros</h2>
    <button type="button" id="close-filters">&times;</button>
  </header>

  <ul class="filter-list">
    {% for spec in cl.filter_specs %}
      <li class="filter-item">
        {% admin_list_filter cl spec %}
      </li>
    {% endfor %}
  </ul>
</aside>

<div id="filters-overlay" class="filters-overlay"></div>


<form method="post" action="">
  {% csrf_token %}
  <div class="table-container">

    {% if has_add_permission or perms.animais.delete_animais%}
      <div class="actions-bar">
        {% if perms.animais.delete_animais %}
          <span id="selected-count">0 selecionados</span>
          <button type="submit"
          name="action"
          value="delete_selected"
          id="btn-remove"
                  class="btn-action"
                  disabled>
            <i class="fas fa-trash"></i> Remover selecionados
          </button>
        {% endif %}
      </div>
    {% endif %} 
  
    <div class="table-wrapper">
      {% result_list cl %}

      {% if cl.result_count == 0%}
        <p class="no-results">Nenhum resultado encontrado.</p>
      {% endif %} 
    </div>
  </form>

  {% if not cl.params.all|stringformat:"s" %}
  <div class="pagination-container">
    <h4>EXIBINDO TODOS OS REGISTROS</h4>
    <div class="pagination">
      <button type="button" class="arrow-btn" id="backToPaged">Voltar à paginação</button>
    </div>
  </div>
{% elif cl.paginator.num_pages > 1 %}
  <div class="pagination-container">
    <h4>VOCÊ ESTÁ NA PÁGINA</h4>
    <div class="pagination">

      {% if cl.page_num > 1 %}
        <button type="button" class="arrow-btn" id="prevPage">‹</button>
      {% else %}
        <button type="button" class="arrow-btn disabled" disabled>‹</button>
      {% endif %}

      <form id="pageForm" class="page-form" method="get">
        {% for key, value in cl.params.items %}
          {% if key != 'p' and key != 'all' %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
          {% endif %}
        {% endfor %}
        <input
          type="number"
          name="p"
          id="pageInput"
          value="{{ cl.page_num }}"
          min="1"
          max="{{ cl.paginator.num_pages }}"
          data-current="{{ cl.page_num }}">
      </form>

      <span class="divider"></span>
      <span class="page-total display-box">{{ cl.paginator.num_pages }}</span>

      {% if cl.page_num < cl.paginator.num_pages %}
        <button type="button" class="arrow-btn" id="nextPage">›</button>
      {% else %}
        <button type="button" class="arrow-btn disabled" disabled>›</button>
      {% endif %}

      <button type="button" class="show-all-btn" id="showAll">Mostrar tudo</button>
    </div>
  </div>
{% endif %}
{% endblock %}

{% block extrajs %}
  <script>
      window.addEventListener('DOMContentLoaded', function () {
    const toggle = document.getElementById('action-toggle');
    const checks = document.querySelectorAll('.action-select');

    if (toggle && checks.length) {
      toggle.addEventListener('change', function () {
        checks.forEach(c => c.checked = toggle.checked);
      });
    }
  });


  document.addEventListener('DOMContentLoaded', () => {
  const countEl  = document.getElementById('selected-count');
  const btnRemove= document.getElementById('btn-remove');
  const checkAll = document.getElementById('action-toggle');
  const checks   = Array.from(document.querySelectorAll('input.action-select'));

  function refreshActions() {
    const checkedCount = checks.filter(c => c.checked).length;
    countEl.textContent = checkedCount
      ? `${checkedCount} selecionado${checkedCount>1?'s':''}`
      : '0 selecionados';
    btnRemove.disabled = checkedCount === 0;
  }

  checks.forEach(c => c.addEventListener('change', refreshActions));

  if (checkAll) {
    checkAll.addEventListener('change', () => {
      checks.forEach(c => c.checked = checkAll.checked);
      refreshActions();
    });
  }

  refreshActions();
});

document.addEventListener('DOMContentLoaded', function () {
    const selects = document.querySelectorAll('.grp-filter-choice');
    selects.forEach(select => {
      select.addEventListener('change', function () {
        if (this.value) {
          window.location.href = this.value;
        }
      });
    });
  });

  const sidebar = document.getElementById('filters-sidebar');
const overlay = document.getElementById('filters-overlay');
const openBtn = document.querySelector('.fa-filter');
const closeBtn = document.getElementById('close-filters');

openBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  sidebar.classList.add('open');
  overlay.classList.add('open');
});

closeBtn.addEventListener('click', () => {
  sidebar.classList.remove('open');
  overlay.classList.remove('open');
});

document.addEventListener('click', (e) => {
  if (
    sidebar.classList.contains('open') &&
    !sidebar.contains(e.target) &&
    !openBtn.contains(e.target)
  ) {
    sidebar.classList.remove('open');
    overlay.classList.remove('open');
  }
});

 document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('.search-container');
    const input = form.querySelector('input[name="q"]');

    form.addEventListener('submit', e => {
      if (input.value.trim() === '') {
        e.preventDefault();
        window.location.href = window.location.pathname;
      }
    });
  });


  </script>
{% endblock extrajs %}

